<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Liste des √©l√©ments</title>
  <style>
    .history-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 10;
      display: none;
    }

      .history-list li {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        cursor: pointer;
        position: relative;
      }
      .history-list li button {
        position: absolute;
        right: 1rem;
        background: none;
        border: none;
        cursor: pointer;
        color: #e74c3c;
      }

    .history-list li:hover {
      background-color: #f2f2f2;
    }

    .no-results {
      display: none;
      text-align: center;
      color: #888;
      font-style: italic;
      margin-top: 1rem;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }

      header {
        background-color: #2c3e50;
        color: white;
        text-align: center;
        padding: 1.5rem 0;
        font-size: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
      }

      .container {
        padding: 2rem;
        min-height: 80vh;
        margin-top: 100px;
      }

    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease;
    }

    .fab:hover {
      background-color: #2980b9;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal.show {
      display: flex !important;
      opacity: 1;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      width: calc(100% - 2rem);
      max-width: 380px;
      box-sizing: border-box;
      text-align: center;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-content h2 {
      margin-bottom: 1.5rem;
      position: relative;
    }

    .modal-content h2::after {
      content: "";
      display: block;
      width: 50px;
      height: 3px;
      margin: 10px auto 0;
      background-color: #2ecc71;
      border-radius: 2px;
    }

    .form-group {
      position: relative;
      margin: 2.5rem 0 2rem;
      text-align: left;
    }

    .form-group label {
      position: absolute;
      top: -0.7rem;
      left: 1rem;
      background-color: white;
      padding: 0 0.5rem;
      font-size: 0.95rem;
      font-style: italic;
      color: #555;
      z-index: 1;
    }

    .form-group input {
      width: 100%;
      box-sizing: border-box;
      padding: 1.2rem 1rem 0.6rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-style: italic;
      color: #333;
      font-size: 1rem;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 3px #3498db;
    }

    .form-group select {
      width: 100%;
      box-sizing: border-box;
      padding: 1.2rem 1rem 0.6rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-style: italic;
      color: #333;
      font-size: 1rem;
      background: white;
    }

    .form-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 3px #3498db;
    }

    .modal-content button {
      padding: 0.8rem 2rem;
      background-color: #2ecc71;
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
    }

    .modal-content button:hover {
      background-color: #27ae60;
    }

    .modal-content .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .modal-content .button-group button {
      flex: 1;
    }

  .modal-content .button-group button.cancel {
      background-color: #e74c3c;
    }
  .modal-content .button-group button.gray {
      background-color: #bdc3c7;
    }

    .modal-content button.cancel {
      background-color: #e74c3c;
    }

    .modal-content button.gray {
      background-color: #bdc3c7;
    }


    #feedback {
      display: none;
      text-align: center;
      background-color: #2ecc71;
      color: white;
      padding: 0.5rem;
      margin: 1rem;
      border-radius: 8px;
      font-weight: bold;
    }

    #detailView {
      display: none;
      opacity: 0;
      transition: opacity 0.4s ease;
      margin-top: 0;
    }

    #detailView.show {
      opacity: 1;
    }

    #detailView header {
      position: fixed !important;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background-color: #2c3e50;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }


    #detailContent {
      padding-top: 80px;
    }

    #detailResult {
      padding-top: 100px;
    }

    #floatingButtons {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }

    #floatingButtons button {
      width: 56px;
      height: 56px;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease;
    }

    #floatingButtons button#addDetailBtn {
      background-color: #3498db;
    }

    #floatingButtons button#deleteRowsBtn {
      background-color: #e74c3c;
      font-size: 1rem;
    }

    #floatingButtons button#deleteRowsBtn:hover {
      background-color: #c0392b;
    }

    #floatingButtons button#addDetailBtn:hover {
      background-color: #2980b9;
    }

    #floatingButtons button#exportBtn {
      background-color: #2ecc71;
      font-size: 1rem;
    }

    #floatingButtons button#exportBtn:hover {
      background-color: #27ae60;
    }

    /* Style for detail table cells */
    #detailTable th,
    #detailTable td {
      padding: 8px 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
      text-transform: uppercase;
    }

    .table-wrapper {
      touch-action: manipulation;
      touch-action: pan-x pan-y;
      -ms-touch-action: manipulation;
      overflow-x: auto;
      max-width: 100%;
      padding-bottom: 1rem;
    }

    .table-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 1rem;
    }
  </style>
</head>
<body oncontextmenu="return false;">
  <div id="mainView">
    <header>
      Liste des √©l√©ments
      <button style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;" title="Options">‚ãÆ</button>
      <div class="form-group search-group" style="max-width: 380px; margin: 1rem auto 0;">
        <input type="text" id="quickSearch" placeholder="Recherche..." autocomplete="off">
        <ul class="history-list" id="searchHistoryList"></ul>
      </div>
    </header>
    <div id="feedback">Liste ajout√©e !</div>

    <div class="container" id="mainViewContainer">
      <!-- Contenu √† venir ici -->
      <div id="noResultsMessage" class="no-results">Aucun r√©sultat trouv√©</div>
    </div>

    <button class="fab" title="Ajouter" onclick="openModal()">+</button>
  </div>

  <div id="detailView">
    <header id="detailHeader"></header>
    <div id="detailResult"></div>
    <div id="detailContent"></div>
    <div id="floatingButtons" style="display:none;">
      <button id="deleteRowsBtn" title="Supprimer" onclick="openDeleteRowsModal()" style="display:none;">üóë</button>
      <button id="exportBtn">Exporter</button>
      <button id="addDetailBtn" title="Ajouter" onclick="openAddDetailModal()">+</button>
    </div>
  </div>

  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <h2 id="modalTitle">Cr√©er une liste</h2>
      <div class="form-group">
        <label for="listName">Nom de la liste</label>
        <input type="text" id="listName">
        <ul class="history-list" id="nameHistory"></ul>
      </div>
      <div class="form-group">
        <label for="siteCode">Code du site</label>
        <input type="text" id="siteCode">
        <ul class="history-list" id="codeHistory"></ul>
      </div>
      <div class="form-group">
        <label for="entryDate">Date d'entr√©e</label>
        <input type="date" id="entryDate">
      </div>
      <div class="form-group">
        <label for="exitDate">Date de sortie</label>
        <input type="date" id="exitDate">
      </div>
      <div class="button-group">
        <button type="button" onclick="createList()">Cr√©er</button>
        <button type="button" class="cancel" onclick="closeModal()">Annuler</button>
      </div>
    </div>
  </div>


  <div class="modal" id="editModal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-content">
      <h2 id="editTitle">Modifier le nom de la liste</h2>
      <div class="form-group">
        <label for="editName">Nom de la liste</label>
        <input type="text" id="editName">
      </div>
      <button type="button" onclick="saveEdit()">Enregistrer</button>
    </div>
  </div>

  <div class="modal" id="deleteModal" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
    <div class="modal-content">
      <h2 id="deleteTitle">Voulez-vous supprimer cette liste ?</h2>
      <div class="button-group">
        <button type="button" class="cancel" onclick="confirmDelete()">OK</button>
        <button type="button" class="gray" onclick="closeDeleteModal()">Annuler</button>
      </div>
    </div>
  </div>

  <div class="modal" id="actionModal" role="dialog" aria-modal="true" aria-labelledby="actionTitle">
    <div class="modal-content">
      <h2 id="actionTitle">Actions</h2>
      <div class="button-group">
        <button type="button" class="cancel" onclick="openDeleteModal()">Supprimer</button>
        <button type="button" class="gray" onclick="closeActionModal()">Annuler</button>
      </div>
    </div>
  </div>

  <div class="modal" id="addDetailModal" role="dialog" aria-modal="true" aria-labelledby="addDetailTitle">
    <div class="modal-content">
      <h2 id="addDetailTitle">Ajouter un √©l√©ment</h2>
      <div class="form-group">
        <label for="designation">D√©signation</label>
        <input type="text" id="designation">
      </div>
      <div class="form-group">
        <label for="qtyBtrs">Qt√© BTRS</label>
        <input type="text" id="qtyBtrs">
      </div>
      <div class="form-group">
        <label for="qtyReturn">Qt√© retourner</label>
        <input type="text" id="qtyReturn">
      </div>
      <div class="form-group">
        <label for="storeSelect">Magasin</label>
        <select id="storeSelect">
          <option value="TiTan 1">TiTan 1</option>
          <option value="Hag 36">Hag 36</option>
          <option value="autre">Autre</option>
        </select>
      </div>
      <div class="form-group" id="customStoreGroup" style="display:none">
        <label for="customStore">Autre magasin</label>
        <input type="text" id="customStore">
      </div>
      <div class="form-group">
        <label for="remark">Remarque</label>
        <input type="text" id="remark">
      </div>
      <button type="button" onclick="addDetailItem()">Ajouter</button>
    </div>
  </div>

  <div class="modal" id="deleteRowsModal" role="dialog" aria-modal="true" aria-labelledby="deleteRowsTitle">
    <div class="modal-content">
      <h2 id="deleteRowsTitle">Voulez-vous supprimer ?</h2>
      <div class="button-group">
        <button type="button" class="cancel" onclick="confirmRowDelete()">OK</button>
        <button type="button" class="gray" onclick="closeDeleteRowsModal()">Annuler</button>
      </div>
    </div>
  </div>

  <script>
    function openModal() {
      const modal = document.getElementById('modal');
      modal.classList.add('show');
      modal.style.display = 'flex';
      document.querySelectorAll('.modal-content input').forEach(i => {
        i.value = '';
        if (i.type === 'text') {
          i.oninput = () => showGenericHistory(i.id, i.value);
          const mapping = {listName: 'nameHistory', siteCode: 'codeHistory'};
          const listId = mapping[i.id] || i.id + 'History';
          i.onblur = () => {
            setTimeout(() => {
              const list = document.getElementById(listId);
              if (list) list.style.display = 'none';
            }, 100);
          };
        }
      });
    }

  function closeModal() {
    const modal = document.getElementById('modal');
    modal.classList.remove('show');
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
  }

  function getTableKey(name) {
    return 'tableData_' + name.replace(/\s+/g, '').toLowerCase();
  }

  /* IndexedDB helpers */
  let dbInstance;
  let dbDisabled = false;

  function openDb() {
    if (dbDisabled || !('indexedDB' in window)) return Promise.reject();
    if (dbInstance) return Promise.resolve(dbInstance);
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('ListeElementsDB', 1);
      req.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('tableaux')) {
          db.createObjectStore('tableaux', { keyPath: 'key' });
        }
      };
      req.onerror = () => {
        dbDisabled = true;
        reject();
      };
      req.onsuccess = () => {
        dbInstance = req.result;
        resolve(dbInstance);
      };
    });
  }

  async function dbGetRows(key) {
    if (dbDisabled) {
      return JSON.parse(localStorage.getItem(key)) || [];
    }
    try {
      const db = await openDb();
      return new Promise(resolve => {
        const tx = db.transaction('tableaux', 'readonly');
        const store = tx.objectStore('tableaux');
        const get = store.get(key);
        get.onsuccess = () => resolve(get.result ? get.result.rows || [] : []);
        get.onerror = () => resolve([]);
      });
    } catch (e) {
      return JSON.parse(localStorage.getItem(key)) || [];
    }
  }

  async function dbSetRows(key, rows) {
    if (dbDisabled) {
      localStorage.setItem(key, JSON.stringify(rows));
      return;
    }
    try {
      const db = await openDb();
      return new Promise(resolve => {
        const tx = db.transaction('tableaux', 'readwrite');
        tx.objectStore('tableaux').put({ key, rows });
        tx.oncomplete = () => resolve();
        tx.onerror = () => {
          dbDisabled = true;
          localStorage.setItem(key, JSON.stringify(rows));
          resolve();
        };
      });
    } catch (e) {
      localStorage.setItem(key, JSON.stringify(rows));
    }
  }

  async function dbAddRow(key, row) {
    const rows = await dbGetRows(key);
    rows.push(row);
    await dbSetRows(key, rows);
  }

  async function dbDeleteRows(key, remaining) {
    await dbSetRows(key, remaining);
  }

  async function dbRenameKey(oldKey, newKey) {
    const rows = await dbGetRows(oldKey);
    if (rows.length) await dbSetRows(newKey, rows);
    if (dbDisabled) {
      localStorage.removeItem(oldKey);
      return;
    }
    try {
      const db = await openDb();
      return new Promise(resolve => {
        const tx = db.transaction('tableaux', 'readwrite');
        tx.objectStore('tableaux').delete(oldKey);
        tx.oncomplete = () => resolve();
        tx.onerror = () => {
          localStorage.removeItem(oldKey);
          resolve();
        };
      });
    } catch (e) {
      localStorage.removeItem(oldKey);
    }
  }

  async function dbDeleteKey(key) {
    if (dbDisabled) {
      localStorage.removeItem(key);
      return;
    }
    try {
      const db = await openDb();
      return new Promise(resolve => {
        const tx = db.transaction('tableaux', 'readwrite');
        tx.objectStore('tableaux').delete(key);
        tx.oncomplete = () => resolve();
        tx.onerror = () => {
          localStorage.removeItem(key);
          resolve();
        };
      });
    } catch (e) {
      localStorage.removeItem(key);
    }
  }

  function computePlaced(btrs, ret) {
    const n1 = parseFloat(btrs);
    const n2 = parseFloat(ret);
    return !isNaN(n1) && !isNaN(n2) ? n1 - n2 : '-';
  }

  function formatCell(val) {
    return val === undefined || val === null || val === '' ? '-' : val;
  }

  function createDetailTable() {
    const table = document.createElement('table');
    table.id = 'detailTable';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '20px';
    table.style.marginLeft = 'auto';
    table.style.marginRight = 'auto';
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headers = [
      '#',
      'Code du site',
      'Nom de site',
      'D√©signation',
      'Qt√© BTRS',
      'Qt√© retourner',
      'Qt√© pos√©e',
      'Magasin',
      'Remarque',
      'ACTION'
    ];
    headers.forEach(text => {
      const th = document.createElement('th');
      th.textContent = text;
      th.style.backgroundColor = '#f2f2f2';
      th.style.fontWeight = 'bold';
      th.style.textAlign = 'center';
      th.style.border = '1px solid #ccc';
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    table.appendChild(document.createElement('tbody'));
    return table;
  }

  async function showDetail(element) {
    const detailView = document.getElementById('detailView');
    const mainView = document.getElementById('mainView');
    const header = document.getElementById('detailHeader');
    header.innerHTML = '';
    header.style.position = 'relative';
    const back = document.createElement('button');
    back.textContent = '‚Üê';
    back.style.position = 'absolute';
    back.style.left = '1rem';
    back.style.top = '50%';
    back.style.transform = 'translateY(-50%)';
    back.style.background = 'none';
    back.style.border = 'none';
    back.style.color = 'white';
    back.style.fontSize = '1.5rem';
    back.style.cursor = 'pointer';
    back.onclick = () => window.history.back();
    header.appendChild(back);
    const title = document.createElement('span');
    let { name, code, entryDate, exitDate } = element.dataset;
    if (!code || !entryDate || !exitDate) {
      const items = JSON.parse(localStorage.getItem('listeElements')) || [];
      const found = items.find(el => el.listName === name) || {};
      code = code || found.siteCode;
      entryDate = entryDate || found.entryDate;
      exitDate = exitDate || found.exitDate;
    }
    title.textContent = name;
    header.appendChild(title);

    const detailResult = document.getElementById('detailResult');
    const format = v => v ? v : 'Null';
    detailResult.innerHTML =
      `<div><strong style="color:#000;">Nom du site :</strong> <span style="color:#777;">${format(name)}</span></div>` +
      `<div><strong style="color:#000;">Code du site :</strong> <span style="color:#777;">${format(code)}</span></div>` +
      `<div><strong style="color:#000;">Date d'entr√©e site :</strong> <span style="color:#777;">${format(entryDate)}</span></div>` +
      `<div><strong style="color:#000;">Date de sortie site :</strong> <span style="color:#777;">${format(exitDate)}</span></div>`;

    const key = getTableKey(name);
    detailView.dataset.tableKey = key;
    const existingTable = document.getElementById('detailTable');
    if (existingTable) existingTable.remove();
    const existingWrapper = detailView.querySelector('.table-wrapper');
    if (existingWrapper) existingWrapper.remove();
    const existingFilters = detailView.querySelector('.table-filters');
    if (existingFilters) existingFilters.remove();
    const savedRows = await dbGetRows(key);
    if (savedRows.length > 0) {
      const table = createDetailTable();
      const tbody = table.querySelector('tbody');
      const stores = [];
      savedRows.forEach((r, idx) => {
        const placed = computePlaced(r.qtyBtrs, r.qtyReturn);
        const values = [
          r.siteCode,
          r.siteName,
          r.designation,
          r.qtyBtrs,
          r.qtyReturn,
          placed,
          r.store,
          r.remark
        ];
        const row = document.createElement('tr');
        const num = document.createElement('td');
        num.textContent = idx + 1;
        num.style.border = '1px solid #ccc';
        row.appendChild(num);
        values.forEach(val => {
          const td = document.createElement('td');
          td.textContent = formatCell(val);
          td.style.border = '1px solid #ccc';
          if (val === undefined || val === null || val === '') td.style.color = '#777';
          row.appendChild(td);
        });
        const action = document.createElement('td');
        action.style.border = '1px solid #ccc';
        const box = document.createElement('input');
        box.type = 'checkbox';
        box.onchange = updateDeleteButtonVisibility;
        action.appendChild(box);
        row.appendChild(action);
        tbody.appendChild(row);
        if (r.store && !stores.includes(r.store)) stores.push(r.store);
      });
      const wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      wrapper.appendChild(table);
      createDetailFilters(stores);
      detailView.appendChild(wrapper);
    }

    updateDeleteButtonVisibility();

    const float = document.getElementById('floatingButtons');
    float.style.display = 'flex';
    updateExportVisibility();

    detailView.style.display = 'block';
    mainView.style.display = 'none';
    requestAnimationFrame(() => detailView.classList.add('show'));

    localStorage.setItem('currentPage', 'detail');
    localStorage.setItem('currentListName', name);
    const anchor = '#detail-' + encodeURIComponent(name);
    window.history.pushState({page: 'detail', name}, '', anchor);
  }

  function showDetailView(name) {
    const items = document.querySelectorAll('#mainView .container > div');
    const el = Array.from(items).find(d => d.dataset.name === name);
    if (el) {
      showDetail(el);
    }
  }

  function hideDetail() {
    const detailView = document.getElementById('detailView');
    const mainView = document.getElementById('mainView');
    document.getElementById('floatingButtons').style.display = 'none';
    updateDeleteButtonVisibility();
    detailView.classList.remove('show');
    setTimeout(() => {
      detailView.style.display = 'none';
    }, 400);
    mainView.style.display = 'block';
    localStorage.setItem('currentPage', 'main');
    localStorage.removeItem('currentListName');
  }

  function openActionModal(index) {
    const modal = document.getElementById('actionModal');
    if (!modal) return;
    modal.dataset.index = index;
    modal.classList.add('show');
    modal.style.display = 'flex';
  }

  function closeActionModal() {
    const modal = document.getElementById('actionModal');
    if (!modal) return;
    modal.classList.remove('show');
    setTimeout(() => { modal.style.display = 'none'; }, 300);
  }


  function openEditModal(index) {
    if (index === undefined) {
      const a = document.getElementById('actionModal');
      index = a ? a.dataset.index : undefined;
    }
    const elements = JSON.parse(localStorage.getItem('listeElements')) || [];
    const item = elements[index];
    if (!item) return;
    document.getElementById('editName').value = item.listName;
    const modal = document.getElementById('editModal');
    modal.dataset.index = index;
    modal.classList.add('show');
    modal.style.display = 'flex';
    closeActionModal();
  }

  async function saveEdit() {
    const modal = document.getElementById('editModal');
    const index = modal.dataset.index;
    const elements = JSON.parse(localStorage.getItem('listeElements')) || [];
    if (elements[index]) {
      const oldName = elements[index].listName || '';
      const newName = document.getElementById('editName').value.trim();
      const oldKey = getTableKey(oldName);
      const newKey = getTableKey(newName);
      if (oldKey !== newKey) {
        await dbRenameKey(oldKey, newKey);
        if (localStorage.getItem('currentListName') === oldName) {
          localStorage.setItem('currentListName', newName);
        }
      }
      elements[index].listName = newName;
      localStorage.setItem('listeElements', JSON.stringify(elements));
    }
    closeEditModal();
    displayElements();
  }

  function closeEditModal() {
    const modal = document.getElementById('editModal');
    modal.classList.remove('show');
    setTimeout(() => { modal.style.display = 'none'; }, 300);
  }

  function openDeleteModal(index) {
    if (index === undefined) {
      const a = document.getElementById('actionModal');
      index = a ? a.dataset.index : undefined;
    }
    const modal = document.getElementById('deleteModal');
    modal.dataset.index = index;
    modal.classList.add('show');
    modal.style.display = 'flex';
    closeActionModal();
  }

  function confirmDelete() {
    const modal = document.getElementById('deleteModal');
    const index = modal.dataset.index;
    const elements = JSON.parse(localStorage.getItem('listeElements')) || [];
    const item = elements.splice(index, 1)[0];
    if (item && item.listName) {
      const key = getTableKey(item.listName);
      dbDeleteKey(key);
    }
    localStorage.setItem('listeElements', JSON.stringify(elements));
    closeDeleteModal();
    displayElements();
  }

  function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.classList.remove('show');
    setTimeout(() => { modal.style.display = 'none'; }, 300);
  }

  function updateCustomStoreVisibility() {
    const select = document.getElementById('storeSelect');
    const group = document.getElementById('customStoreGroup');
    const input = document.getElementById('customStore');
    if (!select || !group || !input) return;
    localStorage.setItem('dernierMagasin', select.value);
    if (select.value === 'autre') {
      group.style.display = 'block';
    } else {
      group.style.display = 'none';
      input.value = '';
      localStorage.removeItem('dernierMagasinAutre');
    }
  }

  function openAddDetailModal() {
    const modal = document.getElementById('addDetailModal');
    modal.classList.add('show');
    modal.style.display = 'flex';
    document.querySelectorAll('#addDetailModal input').forEach(el => el.value = '');
    document.querySelectorAll('#addDetailModal select').forEach(el => el.value = '');
    const select = document.getElementById('storeSelect');
    const custom = document.getElementById('customStore');
    const last = localStorage.getItem('dernierMagasin');
    if (select && last) select.value = last;
    updateCustomStoreVisibility();
    if (select && select.value === 'autre' && custom) {
      const other = localStorage.getItem('dernierMagasinAutre');
      if (other) custom.value = other;
    }
  }

  function closeAddDetailModal() {
    const modal = document.getElementById('addDetailModal');
    modal.classList.remove('show');
    setTimeout(() => { modal.style.display = 'none'; }, 300);
  }

  async function addDetailItem() {
    const designation = document.getElementById('designation').value.trim().toUpperCase();
    const qtyBtrs = document.getElementById('qtyBtrs').value.trim().toUpperCase();
    const qtyReturn = document.getElementById('qtyReturn').value.trim().toUpperCase();
    const storeSelect = document.getElementById('storeSelect').value;
    const customStore = document.getElementById('customStore').value.trim().toUpperCase();
    const store = (storeSelect === 'autre' ? customStore : storeSelect).toUpperCase();
    const remark = document.getElementById('remark').value.trim().toUpperCase();

    const spans = document.querySelectorAll('#detailResult span');
    const siteName = spans[0] ? spans[0].textContent.trim() : '';
    const siteCode = spans[1] ? spans[1].textContent.trim() : '';
    const entryDate = spans[2] ? spans[2].textContent.trim() : '';
    const exitDate = spans[3] ? spans[3].textContent.trim() : '';

    const dataObj = {
      siteCode,
      siteName,
      designation,
      qtyBtrs,
      qtyReturn,
      store,
      remark,
      entryDate,
      exitDate
    };
    const key = getTableKey(siteName);
    await dbAddRow(key, dataObj);

    const placed = computePlaced(qtyBtrs, qtyReturn);
    const values = [
      siteCode,
      siteName,
      designation,
      qtyBtrs,
      qtyReturn,
      placed,
      store,
      remark
    ];

    let table = document.getElementById('detailTable');
    let wrapper = document.querySelector('#detailView .table-wrapper');
    if (!table) {
      table = createDetailTable();
      const detailView = document.getElementById('detailView');
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'table-wrapper';
        detailView.appendChild(wrapper);
      }
      if (!detailView.querySelector('.table-filters')) createDetailFilters([]);
      wrapper.appendChild(table);
    }

    const tbody = table.querySelector('tbody');
    const row = document.createElement('tr');
    const num = document.createElement('td');
    num.textContent = tbody.children.length + 1;
    num.style.border = '1px solid #ccc';
    row.appendChild(num);
    values.forEach(val => {
      const td = document.createElement('td');
      td.textContent = formatCell(val);
      td.style.border = '1px solid #ccc';
      if (val === undefined || val === null || val === '') td.style.color = '#777';
      row.appendChild(td);
    });
    const action = document.createElement('td');
    action.style.border = '1px solid #ccc';
    const box = document.createElement('input');
    box.type = 'checkbox';
    box.onchange = updateDeleteButtonVisibility;
    action.appendChild(box);
    row.appendChild(action);
    tbody.appendChild(row);

    updateDeleteButtonVisibility();

    updateStoreFilterOptions();

    closeAddDetailModal();
    updateExportVisibility();
  }

  function updateRowIndices() {
    const rows = document.querySelectorAll('#detailTable tbody tr');
    rows.forEach((tr, i) => {
      const cell = tr.querySelector('td');
      if (cell) cell.textContent = i + 1;
    });
  }

  function updateDeleteButtonVisibility() {
    const btn = document.getElementById('deleteRowsBtn');
    const boxes = document.querySelectorAll('#detailTable tbody input[type="checkbox"]');
    const any = Array.from(boxes).some(b => b.checked);
    if (btn) btn.style.display = any ? 'block' : 'none';
  }

  function applyDetailFilters() {
    const code = (document.getElementById('filterSiteCode')?.value || '').trim().toUpperCase();
    const name = (document.getElementById('filterSiteName')?.value || '').trim().toUpperCase();
    const desig = (document.getElementById('filterDesignation')?.value || '').trim().toUpperCase();
    const store = (document.getElementById('filterStore')?.value || '').trim().toUpperCase();
    const rows = document.querySelectorAll('#detailTable tbody tr');
    rows.forEach(row => {
      const cells = row.querySelectorAll('td');
      const c = cells[1]?.textContent.toUpperCase() || '';
      const n = cells[2]?.textContent.toUpperCase() || '';
      const d = cells[3]?.textContent.toUpperCase() || '';
      const s = cells[7]?.textContent.toUpperCase() || '';
      const show = (!code || c.includes(code)) &&
                   (!name || n.includes(name)) &&
                   (!desig || d.includes(desig)) &&
                   (!store || s === store);
      row.style.display = show ? '' : 'none';
    });
  }

  function resetDetailFilters() {
    const code = document.getElementById('filterSiteCode');
    const name = document.getElementById('filterSiteName');
    const desig = document.getElementById('filterDesignation');
    const store = document.getElementById('filterStore');
    if (code) code.value = '';
    if (name) name.value = '';
    if (desig) desig.value = '';
    if (store) store.value = '';
    applyDetailFilters();
  }

  function createDetailFilters(stores) {
    const detailView = document.getElementById('detailView');
    let container = detailView.querySelector('.table-filters');
    if (container) container.remove();
    container = document.createElement('div');
    container.className = 'table-filters';
    container.innerHTML =
      '<input type="text" id="filterSiteCode" placeholder="Code du site">' +
      '<input type="text" id="filterSiteName" placeholder="Nom du site">' +
      '<input type="text" id="filterDesignation" placeholder="D√©signation">' +
      '<select id="filterStore"><option value="">Magasin</option></select>' +
      '<button type="button" id="resetFilters">R√©initialiser</button>';
    const wrapper = detailView.querySelector('.table-wrapper');
    detailView.insertBefore(container, wrapper);
    const select = container.querySelector('#filterStore');
    stores.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      select.appendChild(opt);
    });
    container.querySelectorAll('input').forEach(inp => inp.addEventListener('input', applyDetailFilters));
    select.addEventListener('change', applyDetailFilters);
    container.querySelector('#resetFilters').addEventListener('click', resetDetailFilters);
  }

  function updateStoreFilterOptions() {
    const select = document.getElementById('filterStore');
    if (!select) return;
    const current = select.value;
    const rows = document.querySelectorAll('#detailTable tbody tr');
    const stores = new Set();
    rows.forEach(row => {
      const val = row.querySelectorAll('td')[7]?.textContent;
      if (val) stores.add(val);
    });
    select.innerHTML = '<option value="">Magasin</option>';
    stores.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      select.appendChild(opt);
    });
    if (current && [...stores].includes(current)) select.value = current; else select.value = '';
  }

  function openDeleteRowsModal() {
    const modal = document.getElementById('deleteRowsModal');
    if (modal) {
      modal.classList.add('show');
      modal.style.display = 'flex';
    }
  }

  function closeDeleteRowsModal() {
    const modal = document.getElementById('deleteRowsModal');
    if (modal) {
      modal.classList.remove('show');
      setTimeout(() => { modal.style.display = 'none'; }, 300);
    }
  }

  async function confirmRowDelete() {
    const key = document.getElementById('detailView').dataset.tableKey;
    const tbody = document.querySelector('#detailTable tbody');
    if (!tbody) return;
    const stored = await dbGetRows(key);
    const remaining = [];
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach((tr, idx) => {
      const box = tr.querySelector('input[type="checkbox"]');
      if (box && box.checked) {
        tr.remove();
      } else {
        remaining.push(stored[idx]);
      }
    });
    await dbDeleteRows(key, remaining);
    updateRowIndices();
    updateDeleteButtonVisibility();
    updateStoreFilterOptions();
    updateExportVisibility();
    closeDeleteRowsModal();
  }

  function addElementToDOM(item, index) {
    const container = document.querySelector('.container');
    const msg = document.getElementById('noResultsMessage');
    const newListItem = document.createElement('div');
    newListItem.textContent = item.listName.toUpperCase();
    newListItem.style.padding = '1rem';
    newListItem.style.margin = '1rem 0';
    newListItem.style.background = '#ecf0f1';
    newListItem.style.borderRadius = '8px';
    newListItem.style.fontWeight = 'bold';
    newListItem.style.position = 'relative';
    const editBtn = document.createElement('span');
    editBtn.textContent = '‚úé';
    editBtn.style.position = 'absolute';
    editBtn.style.right = '0.5rem';
    editBtn.style.fontSize = '0.9rem';
    editBtn.style.cursor = 'pointer';
    editBtn.dataset.index = index;
    editBtn.onclick = (e) => {
      e.stopPropagation();
      openActionModal(index);
    };
    newListItem.appendChild(editBtn);
    newListItem.dataset.name = item.listName || '';
    newListItem.dataset.code = item.siteCode || '';
    newListItem.dataset.entryDate = item.entryDate || '';
    newListItem.dataset.exitDate = item.exitDate || '';
    newListItem.onclick = () => showDetail(newListItem);
    container.insertBefore(newListItem, msg);
  }

  function displayElements() {
    document.querySelectorAll('.container > div:not(#noResultsMessage)').forEach(el => el.remove());
    const elements = JSON.parse(localStorage.getItem('listeElements')) || [];
    elements.forEach((el, idx) => addElementToDOM(el, idx));
    filterDisplayedLists();
  }

    function createList() {
      const listName = document.getElementById('listName').value.trim();
      const siteCode = document.getElementById('siteCode').value.trim();
      const entryDate = document.getElementById('entryDate').value;
      const exitDate = document.getElementById('exitDate').value;

      const elements = JSON.parse(localStorage.getItem('listeElements')) || [];
      elements.push({ listName, siteCode, entryDate, exitDate });
      localStorage.setItem('listeElements', JSON.stringify(elements));

      displayElements();

      let history = JSON.parse(localStorage.getItem('listNameHistory')) || [];
      if (!history.includes(listName)) {
        history.push(listName);
        localStorage.setItem('listNameHistory', JSON.stringify(history));
      }

      let codeHistory = JSON.parse(localStorage.getItem('siteCodeHistory')) || [];
      if (siteCode && !codeHistory.includes(siteCode)) {
        codeHistory.push(siteCode);
        localStorage.setItem('siteCodeHistory', JSON.stringify(codeHistory));
      }

      const feedback = document.getElementById('feedback');
      feedback.style.display = 'block';
      setTimeout(() => feedback.style.display = 'none', 2000);
      closeModal();
    }

    function showGenericHistory(inputId, filter = '') {
      const mapping = {listName: 'nameHistory', siteCode: 'codeHistory', quickSearch: 'searchHistoryList'};
      const keyMapping = {quickSearch: 'searchHistory'};
      const listId = mapping[inputId] || inputId + 'History';
      const input = document.getElementById(inputId);
      const historyList = document.getElementById(listId);
      const key = keyMapping[inputId] || inputId + 'History';
      let history = JSON.parse(localStorage.getItem(key)) || [];
      history = history.map(h => h.trim()).filter(h => h !== '');
      localStorage.setItem(key, JSON.stringify(history));
      historyList.innerHTML = '';
      const lowerFilter = filter.toLowerCase();
      history.forEach((item, index) => {
        if (!lowerFilter || item.toLowerCase().includes(lowerFilter)) {
          const li = document.createElement('li');
          const span = document.createElement('span');
          span.textContent = item;
          li.appendChild(span);
          const btn = document.createElement('button');
          btn.textContent = '‚úï';
          btn.style.background = 'none';
          btn.style.border = 'none';
          btn.style.cursor = 'pointer';
          btn.style.position = 'absolute';
          btn.style.right = '1rem';
          btn.style.color = '#e74c3c';
          btn.onclick = (e) => {
            e.stopPropagation();
            history.splice(index, 1);
            localStorage.setItem(key, JSON.stringify(history));
            showGenericHistory(inputId, filter);
          };
          li.onclick = () => {
            input.value = item;
            historyList.style.display = 'none';
          };
          li.appendChild(btn);
          historyList.appendChild(li);
        }
      });
      if (historyList.childElementCount > 0 && filter !== '') {
        historyList.style.display = 'block';
      } else {
        historyList.style.display = 'none';
      }
    }

    function showHistory() {
      const input = document.getElementById('listName');
      showGenericHistory('listName', input.value);
    }

    function showCodeHistory() {
      const input = document.getElementById('siteCode');
      showGenericHistory('siteCode', input.value);
    }

  function filterDisplayedLists() {
      const value = document.getElementById('quickSearch').value.trim().toUpperCase();
      const items = document.querySelectorAll('.container > div:not(#noResultsMessage)');
      let anyVisible = false;
      items.forEach(item => {
        if (!value || item.innerText.toUpperCase().includes(value)) {
          item.style.display = '';
          anyVisible = true;
        } else {
          item.style.display = 'none';
        }
      });
      const msg = document.getElementById('noResultsMessage');
      if (!anyVisible && value) {
        msg.style.display = 'block';
      } else {
        msg.style.display = 'none';
      }
    }

    const quick = document.getElementById('quickSearch');
    quick.addEventListener('input', (e) => {
      showGenericHistory('quickSearch', e.target.value);
      filterDisplayedLists();
    });
    quick.addEventListener('blur', () => {
      setTimeout(() => {
        const list = document.getElementById('searchHistoryList');
        if (list) list.style.display = 'none';
      }, 100);
    });

  function updateExportVisibility() {
    const exportBtn = document.getElementById('exportBtn');
    const table = document.querySelector('#detailView table');
    if (exportBtn) {
      exportBtn.style.display = table ? 'block' : 'none';
    }
  }

  function getCsvSeparator() {
    const sample = (1.1).toLocaleString();
    return sample.includes(',') ? ';' : ',';
  }

  function exportTableData() {
    const table = document.querySelector('#detailView table');
    if (!table) return;

    const sep = getCsvSeparator();
    const lines = [];

    const headers = Array.from(table.querySelectorAll('thead th'))
      .map(th => '"' + th.textContent.trim().toUpperCase().replace(/"/g, '""') + '"');
    lines.push(headers.join(sep));

    const rows = Array.from(table.querySelectorAll('tbody tr'))
      .filter(r => r.style.display !== 'none');
    rows.forEach(row => {
      const cells = Array.from(row.querySelectorAll('td'));
      const line = cells.map(td => {
        let val = td.textContent.trim();
        if (!val || val === '-' || val.toLowerCase() === 'null') val = '-';
        val = val.replace(/[\r\n]+/g, ' ');
        return '"' + val.toUpperCase().replace(/"/g, '""') + '"';
      }).join(sep);
      lines.push(line);
    });

    const csv = lines.join('\n');
    const bom = '\uFEFF';

    const spans = document.querySelectorAll('#detailResult span');
    const name = spans[0] ? spans[0].textContent.trim() : 'liste';
    const code = spans[1] ? spans[1].textContent.trim() : 'site';
    const filename = `${code}_${name}`.replace(/\s+/g, '').toUpperCase() + '.csv';

    const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    // alert('Pour une meilleure lisibilit√©, appliquez un style gris clair √† la premi√®re ligne dans Excel.');
  }

  document.getElementById('exportBtn').onclick = exportTableData;

  window.onclick = function(event) {
    const modal = document.getElementById('modal');
    const addDetail = document.getElementById('addDetailModal');
    const delRows = document.getElementById('deleteRowsModal');
    const action = document.getElementById('actionModal');
    if (event.target === modal) {
      closeModal();
    }
    if (event.target === addDetail) {
      closeAddDetailModal();
    }
    if (event.target === delRows) {
      closeDeleteRowsModal();
    }
    if (event.target === action) {
      closeActionModal();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    window.history.replaceState({page: 'main'}, '', '#');
    displayElements();
    const page = localStorage.getItem('currentPage');
    const listName = localStorage.getItem('currentListName');
    if (page === 'detail' && listName) {
      showDetailView(listName);
    }
    const select = document.getElementById('storeSelect');
    if (select) {
      select.addEventListener('change', () => {
        updateCustomStoreVisibility();
      });
    }
    const custom = document.getElementById('customStore');
    if (custom && select) {
      custom.addEventListener('input', () => {
        if (select.value === 'autre') {
          localStorage.setItem('dernierMagasinAutre', custom.value);
        }
      });
    }
    updateCustomStoreVisibility();
    updateExportVisibility();
  });

  window.addEventListener('popstate', () => {
    const detail = document.getElementById('detailView');
    if (detail && detail.style.display === 'block') {
      hideDetail();
    }
  });
  </script>
</body>
</html>
